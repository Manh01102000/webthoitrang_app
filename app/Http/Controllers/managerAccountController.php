<?php

namespace App\Http\Controllers;
use Illuminate\Http\Request;
use App\Models\User;
// JWT
use Tymon\JWTAuth\Facades\JWTAuth;
use Tymon\JWTAuth\Exceptions\TokenExpiredException;
use Tymon\JWTAuth\Exceptions\TokenInvalidException;
use Tymon\JWTAuth\Exceptions\JWTException;
//
use App\Repositories\ManagerAccount\ManagerAccountRepositoryInterface;

class managerAccountController extends Controller
{
    protected $ManagerAccountRepository;
    public function __construct(ManagerAccountRepositoryInterface $ManagerAccountRepository)
    {
        $this->ManagerAccountRepository = $ManagerAccountRepository;
    }
    public function index()
    {
        /** === Khai b√°o th∆∞ vi·ªán s·ª≠ d·ª•ng === */
        $dataversion = [
            'useslick' => 0,
            'useselect2' => 1,
        ];
        /** === X√¢y d·ª±ng SEO === */
        $domain = env('DOMAIN_WEB');
        $dataSeo = [
            'seo_title' => "Qu·∫£n L√Ω T√†i Kho·∫£n - Fashion Houses",
            'seo_desc' => "Qu·∫£n l√Ω th√¥ng tin c√° nh√¢n, theo d√µi ƒë∆°n h√†ng, c·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ giao h√†ng v√† b·∫£o m·∫≠t t√†i kho·∫£n c·ªßa b·∫°n t·∫°i Fashion Houses. Tr·∫£i nghi·ªám mua s·∫Øm th·ªùi trang d·ªÖ d√†ng v√† an to√†n!",
            'seo_keyword' => "Fashion Houses t√†i kho·∫£n, qu·∫£n l√Ω t√†i kho·∫£n, c·∫≠p nh·∫≠t th√¥ng tin c√° nh√¢n, b·∫£o m·∫≠t t√†i kho·∫£n, theo d√µi ƒë∆°n h√†ng, ƒë·ªãa ch·ªâ giao h√†ng, l·ªãch s·ª≠ mua s·∫Øm, t√†i kho·∫£n kh√°ch h√†ng, th·ªùi trang tr·ª±c tuy·∫øn.",
            'canonical' => $domain . '/quan-ly-tai-khoan',
        ];
        /** === X√¢y d·ª±ng breadcrumb === */
        $breadcrumbItems = [
            ['title' => 'Trang ch·ªß', 'url' => '/', 'class' => 'otherssite'],
            [
                'title' => "Qu·∫£n l√Ω t√†i kho·∫£n",
                'url' => '',
                'class' => 'thissite'
            ]
        ];
        /** === Chu·∫©n b·ªã d·ªØ li·ªáu === */
        $data = InForAccount();
        // l·∫•y d·ªØ li·ªáu danh m·ª•c theo t·ª´ng c·∫•p
        $categoryTree = getCategoryTree();
        $dataAll = [
            'data' => $data,
            'breadcrumbItems' => $breadcrumbItems,
            'Category' => $categoryTree,
        ];
        /** === Tr·∫£ v·ªÅ view v·ªõi d·ªØ li·ªáu === */
        return view('manager_account', [
            'dataSeo' => $dataSeo,
            'domain' => $domain,
            'dataversion' => $dataversion,
            'dataAll' => $dataAll,
        ]);
    }

    public function AccountUpdate(Request $request)
    {
        try {
            // üü¢ ======= L·∫•y th√¥ng tin ng∆∞·ªùi d√πng t·ª´ request =======
            $user = $request->user;
            if (!$user) {
                return response()->json(['message' => 'Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng!'], 401);
            }
            $user_id = $user->use_id;
            $userType = $user->use_role;
            // üü¢ Nh·∫≠n d·ªØ li·ªáu t·ª´ request
            $avatar = $request->file('avatar');
            $emp_email_contact = $request->get('emp_email_contact');
            $emp_name = $request->get('emp_name');
            $emp_address = $request->get('emp_address');
            $emp_phone = $request->get('emp_phone');
            $emp_birth = $request->get('emp_birth');
            $ip_address = client_ip();
            if (
                isset($emp_email_contact) && $emp_email_contact != "" &&
                isset($emp_name) && $emp_name != "" &&
                isset($emp_address) && $emp_address != "" &&
                isset($emp_phone) && $emp_phone != "" &&
                isset($emp_birth) && $emp_birth != ""
            ) {
                $data = [
                    'user_id' => $user_id,
                    'userType' => $userType,
                    'avatar' => $avatar,
                    'emp_email_contact' => $emp_email_contact,
                    'emp_name' => $emp_name,
                    'emp_address' => $emp_address,
                    'emp_phone' => $emp_phone,
                    'emp_birth' => $emp_birth,
                    'ip_address' => $ip_address,
                ];
                $response = $this->ManagerAccountRepository->AccountUpdate($data);
                if ($response['success']) {
                    return apiResponse('success', $response['message'], $response['data'], true, $response['httpCode']);
                } else {
                    return apiResponse('error', $response['message'], $response['data'], false, $response['httpCode']);
                }
            }
            return apiResponse('success', 'Thi·∫øu d·ªØ li·ªáu truy·ªÅn l√™n', [], true, 400);
        } catch (JWTException $e) {
            return response()->json(['message' => 'L·ªói x√°c th·ª±c token!'], 401);
        }
    }
}
